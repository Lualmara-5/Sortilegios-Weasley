<!-- Cargando (muy breve la primera vez) -->
<section class="pd-wrap" *ngIf="(product$ | async) === undefined">
  <div class="pd-card"><p>Cargando producto…</p></div>
</section>

<!-- Producto encontrado -->
<section class="pd-wrap" *ngIf="product$ | async as p">
  <div class="pd-card">
    <h1 class="pd-title">{{ p.name }}</h1>

    <div class="pd-content">
      <figure class="pd-media">
        <img class="pd-img" [src]="p.image" [alt]="p.name" />
      </figure>

      <div class="pd-info">
        <p class="pd-desc">{{ p.description }}</p>

        <div class="pd-meta">
          <p><strong>Precio:</strong> {{ p.price }} / {{ p.unit }}</p>
          <p><strong>Categoría:</strong> {{ p.category }}</p>
        </div>

        <div class="pd-actions">
          <a class="btn btn-secondary" routerLink="/catalogo">← Volver al catálogo</a>
          <button class="btn btn-primary" type="button" (click)="addToWishlist(p)">
            Añadir a lista de deseos
          </button>
        </div>
        <!-- ===== DEMOSTRACIÓN DE EFECTOS MÁGICOS ===== -->
        <app-animation-viewer 
          *ngIf="hasAnimation(p.id)"
          [productId]="p.id">
        </app-animation-viewer>
        <!-- ===== Reseñas del producto ===== -->
        <section class="pd-reviews">
          <h3 class="rv-title">Opiniones y Reseñas Muggle</h3>

          <!-- Resumen -->
          <div class="rv-summary" *ngIf="reviews$ | async as reviews">
            <div class="rv-score">
              <div class="rv-score-number">{{ (avgRating$ | async)?.toFixed(1) }}</div>
              <div class="rv-stars">
                <span
                  *ngFor="let s of [1, 2, 3, 4, 5]"
                  class="star"
                  [class.filled]="s <= Math.round((avgRating$ | async) || 0)"
                  >★</span
                >
              </div>
              <div class="rv-count">Basado en {{ reviews.length }} reseñas</div>
            </div>

            <!-- Lista corta -->
            <div class="rv-list">
              <article class="rv-item" *ngFor="let r of reviews | slice : 0 : 2">
                <img
                  class="rv-avatar"
                  [src]="r?.avatar || 'assets/img/avatars/default.png'"
                  [alt]="r?.author"
                />
                <div class="rv-content">
                  <div class="rv-head">
                    <strong class="rv-author">{{ r?.author }}</strong>
                    <span class="rv-stars-line">
                      <span
                        *ngFor="let s of [1, 2, 3, 4, 5]"
                        class="star"
                        [class.filled]="s <= (r?.rating || 0)"
                        >★</span
                      >
                    </span>
                  </div>
                  <p class="rv-text">{{ r?.text }}</p>
                  <small class="rv-date">{{ r?.createdAt | date : 'medium' }}</small>
                </div>
              </article>
            </div>

            <!-- Acciones -->
            <div class="rv-actions" *ngIf="product$ | async as p">
              <a class="btn btn-secondary" [routerLink]="['/catalogo', p.id, 'resenas']">
                Ver más reseñas
              </a>
              <button class="btn btn-primary" type="button" (click)="toggleForm()">
                {{ showForm ? 'Cancelar' : 'Escribir reseña' }}
              </button>
            </div>

            <!-- Formulario -->
            <form
              class="rv-form"
              *ngIf="showForm && (product$ | async) as p"
              (ngSubmit)="submitReview(p.id)"
            >
              <div class="rv-form-row">
                <input
                  class="rv-input"
                  [(ngModel)]="form.author"
                  name="author"
                  placeholder="Tu nombre..."
                  required
                />
                <select class="rv-input" [(ngModel)]="form.rating" name="rating">
                  <option *ngFor="let s of [5, 4, 3, 2, 1]" [value]="s">{{ s }} ★</option>
                </select>
              </div>
              <textarea
                class="rv-textarea"
                [(ngModel)]="form.text"
                name="text"
                rows="3"
                placeholder="Cuéntanos tu experiencia..."
                required
              ></textarea>
              <div class="rv-actions">
                <button class="btn btn-primary" type="submit">Publicar reseña</button>
              </div>
            </form>
          </div>
        </section>
      </div>
    </div>

    <p class="pd-disclaimer">
      Sortilegios Weasley no se hace responsable por triángulos amorosos, corazones rotos ni
      compromisos mágicos forzados. Compra bajo tu propio riesgo.
    </p>
  </div>

  <div class="glow-row">
    <span class="glow"></span><span class="glow"></span><span class="glow"></span>
  </div>
</section>

<!-- Producto no encontrado -->
<section class="pd-wrap" *ngIf="(product$ | async) === null">
  <div class="pd-card">
    <h2>Producto no encontrado</h2>
    <a class="btn btn-secondary" routerLink="/catalogo">Volver al catálogo</a>
  </div>
</section>
